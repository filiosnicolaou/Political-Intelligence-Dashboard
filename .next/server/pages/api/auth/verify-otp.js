"use strict";(()=>{var e={};e.id=411,e.ids=[411],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7451:(e,r,t)=>{t.r(r),t.d(r,{config:()=>h,default:()=>f,routeModule:()=>m});var a={};t.r(a),t.d(a,{default:()=>handler});var o=t(1802),n=t(7153),s=t(6249);let i=require("jsonwebtoken");var u=t.n(i);let d=require("cookie");var l=t.n(d),p=t(1693),c=t(7027);async function handler(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let{phone:t,otp:a}=e.body;if(!t||!a)return r.status(400).json({error:"Missing fields"});try{let e=await p.Z.oTP.findFirst({where:{phone:t},orderBy:{createdAt:"desc"}});if(!e)return r.status(404).json({error:"No OTP found"});if(new Date(e.expiresAt)<new Date)return r.status(410).json({error:"OTP expired"});let o=(0,c.Z)(String(a),e.codeHash);if(!o)return r.status(401).json({error:"Άκυρος κωδικός"});await p.Z.oTP.deleteMany({where:{phone:t}});let n=await p.Z.member.findUnique({where:{phone:t}});n||(n=await p.Z.member.create({data:{phone:t,role:"MEMBER"}}));let s=process.env.JWT_SECRET||"dev_jwt_secret",i=u().sign({memberId:n.id,phone:n.phone,role:n.role},s,{expiresIn:"7d"});r.setHeader("Set-Cookie",l().serialize("poli_token",i,{httpOnly:!0,secure:!0,path:"/",maxAge:604800})),r.status(200).json({ok:!0})}catch(e){console.error(e),r.status(500).json({error:"Server error"})}}let f=(0,s.l)(a,"default"),h=(0,s.l)(a,"config"),m=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/auth/verify-otp",pathname:"/api/auth/verify-otp",bundlePath:"",filename:""},userland:a})},7027:(e,r,t)=>{t.d(r,{Z:()=>verifyHash,b:()=>hashOtp});var a=t(6113),o=t.n(a);let n=process.env.OTP_SECRET||"dev_otp_secret";function hashOtp(e){return o().createHmac("sha256",n).update(e).digest("hex")}function verifyHash(e,r){let t=hashOtp(e),a=Buffer.from(t),n=Buffer.from(r);return a.length===n.length&&o().timingSafeEqual(a,n)}},1693:(e,r,t)=>{t.d(r,{Z:()=>n});let a=require("@prisma/client"),o=global.prisma||new a.PrismaClient,n=o}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[222],()=>__webpack_exec__(7451));module.exports=t})();